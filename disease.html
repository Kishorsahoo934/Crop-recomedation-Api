<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FarmSathi — Disease Detection</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .center{max-width:820px;margin:18px auto}
    .meta{display:flex;gap:8px;align-items:center;margin-top:8px}
    .badge{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px}
    .rec-list{margin-top:10px}
  </style>
</head>
<body>
  <div class="container center">
    <div class="header"><div class="brand"><div class="logo">FS</div><div><div class="h1">Plant Disease Detection</div><div class="small">Upload leaf image to detect</div></div></div><div><button class="btn" onclick="location.href='dashboard.html'">Back</button></div></div>

    <div class="card">
      <label class="label">Choose image</label>
      <input id="file" class="field" type="file" accept="image/*">
      <div id="preview" class="file-preview" style="margin-top:10px"></div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="uploadBtn">Upload & Predict</button>
        <button class="btn ghost" id="downloadPdfBtn" style="display:none">Download PDF</button>
      </div>

      <div id="out" class="result-box" style="margin-top:12px">
        <div id="diseaseName" style="font-weight:700">No prediction yet</div>
        <div id="diseaseConf" class="small" style="margin-top:6px"></div>
        <div id="recSection" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <script src="common.js"></script>
  <script>
    const fileEl = document.getElementById('file'), preview = document.getElementById('preview'), uploadBtn = document.getElementById('uploadBtn');
    const diseaseName = document.getElementById('diseaseName'), diseaseConf = document.getElementById('diseaseConf'), recSection = document.getElementById('recSection');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    fileEl.addEventListener('change', (e)=>{
      preview.innerHTML = '';
      const f = e.target.files[0];
      if(!f) return;
      const img = document.createElement('img'); img.src = URL.createObjectURL(f); img.onload = ()=> URL.revokeObjectURL(img.src);
      preview.appendChild(img);
    });

    uploadBtn.onclick = async ()=>{
      const f = fileEl.files[0];
      if(!f) return alert('Select an image first');
      diseaseName.textContent = 'Detecting…';
      diseaseConf.textContent = '';
      recSection.innerHTML = '';

      const form = new FormData(); form.append('file', f);
      try{
        const res = await fetch(`${BASE_URL}/predict-disease`, { method:'POST', body: form });
        const j = await res.json();
        if(!res.ok) throw j;

        // expected fields: predicted_disease, confidence, recommendation
        const name = j.predicted_disease || 'Unknown';
        const conf = j.confidence || j.confidence === 0 ? Number(j.confidence) : null;
        const rec = j.recommendation || j.recommendation === '' ? j.recommendation : '';

        diseaseName.textContent = name;
        diseaseConf.innerHTML = conf ? `<span class="badge">Confidence: ${Number(conf).toFixed(2)}%</span>` : '<span class="small">Confidence not provided</span>';

        // convert recommendation string to bullet list — split by sentences and filter
        const bullets = extractBullets(rec);
        if(bullets.length){
          recSection.innerHTML = '<div style="font-weight:600;margin-bottom:6px">Recommendations</div>' + 
            `<div class="rec-list">${bullets.map(b=>`<div class="small">• ${escapeHtml(b)}</div>`).join('')}</div>`;
        } else {
          recSection.innerHTML = '<div class="small">No recommendation provided.</div>';
        }

        // enable download
        downloadPdfBtn.style.display = 'inline-block';
        downloadPdfBtn.onclick = ()=> {
          const lines = [
            `Disease: ${name}`,
            `Confidence: ${conf ? Number(conf).toFixed(2) + '%' : 'N/A'}`,
            'Recommendations:',
            ...bullets.map((b,i)=>`${i+1}. ${b}`)
          ];
          downloadPdf(`Report_${name}`, lines);
        };

      }catch(e){
        diseaseName.textContent = 'Error';
        recSection.innerHTML = '';
        diseaseConf.innerHTML = '';
        showError(document.getElementById('out'), e);
      }
    };

    function extractBullets(raw){
      if(!raw) return [];
      // If response already contains newlines or bullets, split
      // Remove extra whitespace, then split on sentence enders or semicolons or newlines
      let t = String(raw).replace(/\s+/g,' ').trim();
      // if it's JSON-like, try to extract text
      const parts = t.split(/(?:\.\s+)|(?:\;\s+)|(?:\n+)/).map(s=>s.trim()).filter(Boolean);
      // Filter out too short items
      return parts.filter(p=>p.length>8).slice(0,8);
    }
  </script>
</body>
</html>
