<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FarmSathi ‚Äî Disease Detection</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg1:#0f172a; --bg2:#062b1f; --card:#ffffff; --accent:#06b6d4; --muted:#6b7280; --glass: rgba(255,255,255,0.06);} *{box-sizing:border-box}
  body{font-family:'Poppins',sans-serif;margin:0;min-height:100vh;background-color:var(--bg1);background-image: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.35)), url('background.jpg');background-size:cover;background-position:center;background-repeat:no-repeat;color:#e6f2f1;-webkit-font-smoothing:antialiased}
  header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{height:48px;width:48px;border-radius:10px;background:#ffffff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(3,105,161,0.25);overflow:hidden}
  h1{margin:0;font-size:20px}
  .small{font-size:12px;color:var(--muted)}
  main{padding:24px;display:flex;justify-content:center}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6);max-width:820px;width:100%}
  label{display:block;color:#dff6f3;font-size:13px;margin-bottom:6px;font-weight:600}
  input[type="text"], input[type="number"], textarea {width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background: rgba(1,30,27,0.85);color:#e6fbf8;font-size:14px;outline:none}
  input::placeholder, textarea::placeholder { color: rgba(230,251,248,0.75); }
  input:focus, textarea:focus, select:focus { box-shadow: 0 0 0 3px rgba(6,182,212,0.08); border-color: rgba(6,182,212,0.6); }
  select {width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(1,30,27,0.65); color:#dff6f3; font-size:14px; appearance:none; -webkit-appearance:none;}
  select option { background: rgba(1,30,27,0.95); color: #dff6f3; }
  .row{display:flex;gap:10px}
  .col{flex:1}
  .result-box{background:#011e1b;padding:12px;border-radius:8px;margin-top:12px;color:#dff6f3;font-size:14px;line-height:1.45}
  .btn{background:var(--accent);color:#04232a;padding:10px 14px;border-radius:10px;border:none;font-weight:600;cursor:pointer}
  footer{padding:16px;color:var(--muted);text-align:center}
  @media (max-width:980px){ .row{flex-direction:column} }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo"><img src="logo.jpg" alt="FarmSathi" style="width:100%;height:100%;object-fit:cover"></div>
    <div><h1>FarmSathi</h1><div class="small">Disease Detection ‚Äî Odisha focus</div></div>
  </div>
  <div class="small"><a href="index.html" style="color:inherit;text-decoration:underline">‚Üê Home</a></div>
</header>

<main>
  <div class="card">
    <h2>üçÉ Plant Disease Detection</h2>
    <div class="row" style="margin-top:8px">
      <div class="col"><input id="dfile" type="file" accept="image/*"></div>
      <div style="width:140px;display:flex;align-items:center"><button class="btn" onclick="callDisease()">Upload & Predict</button></div>
    </div>
    <div style="margin-top:10px" id="previewArea"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <div id="dloader" style="display:none" class="loader"></div>
      <div id="dstatus" class="small">idle</div>
    </div>
    <div id="diseaseResult" class="result-box">Result will appear here</div>
  </div>
</main>

<footer>FarmSathi UI ‚Ä¢ AI can sometimes make mistakes. Please verify important information.</footer>

<script>
let BASE_URL = localStorage.getItem('FS_BASE_URL') || 'http://127.0.0.1:8000';
function showResultBox(id, lines){ const el=document.getElementById(id); if(!el) return; if(Array.isArray(lines)) el.innerHTML = lines.map(l=>`<div>${l}</div>`).join(''); else el.textContent = lines; }
function showErrorBox(id, err){ const message=(err&&err.detail)?err.detail:(err&&err.message)?err.message:JSON.stringify(err); showResultBox(id, `‚ùå Error: ${message}`); }

function showPreview(file){ const area=document.getElementById('previewArea'); area.innerHTML=''; if(!file) return; const img=document.createElement('img'); img.src=URL.createObjectURL(file); img.onload=()=>URL.revokeObjectURL(img.src); img.style.maxWidth='160px'; img.style.borderRadius='8px'; area.appendChild(img); }
document.getElementById('dfile').addEventListener('change',(e)=> showPreview(e.target.files[0]));

function validateAndCompressImage(file){ return new Promise((resolve,reject)=>{ if(!file.type.startsWith('image/')){ reject(new Error('Please select an image file')); return; } const reader=new FileReader(); reader.readAsDataURL(file); reader.onload=(e)=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{ const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d'); canvas.width=224; canvas.height=224; ctx.drawImage(img,0,0,224,224); canvas.toBlob((blob)=>{ resolve(new File([blob], file.name, { type: 'image/jpeg' })); }, 'image/jpeg', 0.8); }; img.onerror=()=>reject(new Error('Failed to load image')); }; reader.onerror=()=>reject(new Error('Failed to read file')); }); }

async function callDisease(){ const fileInput=document.getElementById('dfile'); if(!fileInput.files.length) return showResultBox('diseaseResult','‚ö†Ô∏è Select an image first.'); document.getElementById('dloader').style.display='inline-block'; document.getElementById('dstatus').textContent='processing...'; showResultBox('diseaseResult','‚è≥ Processing image...'); try{ const compressedFile = await validateAndCompressImage(fileInput.files[0]); const form = new FormData(); form.append('file', compressedFile); document.getElementById('dstatus').textContent='uploading...'; showResultBox('diseaseResult','‚è≥ Uploading & analyzing image...'); const controller = new AbortController(); const timeoutId = setTimeout(()=>controller.abort(),30000); const res = await fetch(`${BASE_URL}/predict-disease`, { method:'POST', body: form, signal: controller.signal }); clearTimeout(timeoutId); const json = await res.json(); if(!res.ok) return showErrorBox('diseaseResult', json); const disease = json.predicted_disease ?? json.disease ?? 'Unknown'; const conf = json.confidence ?? json.confidence_percent ?? 'N/A'; const rec = json.recommendation ?? json.treatment ?? 'No recommendation provided.'; const formattedRec = rec.split('\n').filter(line=>line.trim()).map(line=>{ line=line.trim(); if(/^\d+\./.test(line)) return line; if(line.startsWith('‚Ä¢')) return line; return `‚Ä¢ ${line}`; }); showResultBox('diseaseResult', [ `üåø Disease: ${disease}`, `‚úÖ Confidence: ${conf}${typeof conf === 'number' ? '%' : ''}`, '', 'üõ† Recommendation:', ...formattedRec ]); document.getElementById('dstatus').textContent='success'; }catch(err){ if(err.name==='AbortError'){ showResultBox('diseaseResult','‚ö†Ô∏è Request timed out. Please try again.'); } else if(err.message && err.message.includes('image')){ showResultBox('diseaseResult', `‚ö†Ô∏è ${err.message}`); } else{ showErrorBox('diseaseResult', err); } document.getElementById('dstatus').textContent='error'; } finally{ document.getElementById('dloader').style.display='none'; } }

window.addEventListener('load', ()=> localStorage.setItem('FS_BASE_URL', BASE_URL));
</script>
</body>
</html>
