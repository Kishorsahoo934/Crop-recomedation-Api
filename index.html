<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FarmSathi ‚Äî Developer Console</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0f172a; --bg2:#062b1f; --card:#ffffff; --accent:#06b6d4; --muted:#6b7280;
    --glass: rgba(255,255,255,0.06);
  }
  *{box-sizing:border-box}
  body{
    font-family:'Poppins',sans-serif;
    margin:0; min-height:100vh;
    background: linear-gradient(180deg,var(--bg1) 0%, #063447 60%, #053e2f 100%);
    color:#e6f2f1;
    -webkit-font-smoothing:antialiased;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:18px 28px;
    gap:12px;
  }
  .brand{display:flex;gap:12px;align-items:center}
  .logo{
    height:48px;width:48px;border-radius:10px;
    background:#ffffff;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 6px 18px rgba(3,105,161,0.25);
    overflow:hidden;
  }
  .logo-img {
    width:100%;
    height:100%;
    object-fit:cover;
  }
  h1{margin:0;font-size:20px}
  nav{display:flex;gap:10px;align-items:center}
  .btn{background:var(--accent);color:#04232a;padding:10px 14px;border-radius:10px;border:none;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(6,182,212,0.12)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dff6f3}
  main{padding:24px;display:grid;grid-template-columns: 1fr 420px; gap:22px;}
  .left{display:grid;gap:18px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 8px 30px rgba(2,6,23,0.6);
    transition: transform .22s ease, box-shadow .22s ease;
  }
  .card:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(2,6,23,0.7)}
  .card h2{margin:0 0 8px 0;font-size:16px;color:#e6fbf8}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    label{display:block;color:#dff6f3;font-size:13px;margin-bottom:6px;font-weight:600}
  input[type="text"], input[type="number"], textarea {
    width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);
    background: rgba(1,30,27,0.85); color:#e6fbf8;font-size:14px; outline: none;
  }
  input::placeholder, textarea::placeholder { color: rgba(230,251,248,0.75); }
  input:focus, textarea:focus, select:focus { box-shadow: 0 0 0 3px rgba(6,182,212,0.08); border-color: rgba(6,182,212,0.6); }
  .row{display:flex;gap:10px}
  .col{flex:1}
  .small{font-size:12px;color:var(--muted)}
  pre.json{
    background:#021617;padding:12px;border-radius:8px;overflow:auto;color:#9ff3e9;margin-top:12px;font-size:13px;
    white-space:pre-wrap;
  }
  .result-box{
    background:#011e1b;padding:12px;border-radius:8px;margin-top:12px;color:#dff6f3;font-size:14px;
    line-height:1.45;
  }
  /* Right column */
  .right{position:relative}
  .card.tall{height:100%}
  .robot-btn{
    position:fixed;right:28px;bottom:28px;width:68px;height:68px;border-radius:999px;
    background:linear-gradient(135deg,#06b6d4,#3b82f6);border:none;color:#04232a;font-weight:700;
    box-shadow:0 14px 40px rgba(3,105,161,0.28);display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;
    transition:transform .15s ease;
    z-index:1300;
  }
  .robot-btn:hover{transform:scale(1.06)}
  /* Chat Modal */
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;z-index:1500}
  .chat-modal{width:420px;max-width:96%;height:600px;background:linear-gradient(180deg,#072525, #032f2a);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.6)}
  .chat-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
  .chat-body{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .bubble{max-width:78%;padding:10px;border-radius:10px;background:#0b2220;color:#dff6f3;align-self:flex-start}
  .bubble.user{background:#06b6d4;color:#04232a;align-self:flex-end}
  .chat-input{display:flex;gap:8px;padding-top:8px}
  .chat-input input{flex:1;padding:10px;border-radius:8px;border:none}
  footer{padding:16px;color:var(--muted);text-align:center}
  @media (max-width:980px){ main{grid-template-columns:1fr} .right{order:2} .left{order:1} }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">
      <img src="logo.jpg" alt="FarmSathi" class="logo-img">
    </div>
    <div>
      <h1>FarmSathi</h1>
      <div class="small">Your Smart Farming Assistant</div>
    </div>
  </div>

  <nav>
    <div id="userArea" class="small">Welcome</div>
  </nav>
</header>

<main>
  <section class="left">
    <!-- Homepage tiles linking to dedicated pages -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px">
      <a href="crop_recommend.html" style="text-decoration:none;color:inherit">
        <div class="card" style="cursor:pointer">
          <h2>üåæ Crop Recommendation</h2>
          <div class="small">Get recommended crops based on soil and weather parameters.</div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px">Open page ‚Üí</div>
        </div>
      </a>

      <a href="fertilizer_recommend.html" style="text-decoration:none;color:inherit">
        <div class="card" style="cursor:pointer">
          <h2>üß™ Fertilizer Recommendation</h2>
          <div class="small">Find the best fertilizer for your crop and soil.</div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px">Open page ‚Üí</div>
        </div>
      </a>

      <a href="disease_detection.html" style="text-decoration:none;color:inherit">
        <div class="card" style="cursor:pointer">
          <h2>üçÉ Plant Disease Detection</h2>
          <div class="small">Upload a leaf image to detect disease and get recommendations.</div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px">Open page ‚Üí</div>
        </div>
      </a>
    </div>
  </section>

  <aside class="right">
    <!-- Chat console removed: chatbot accessible via floating robot button -->
    <!-- Settings hidden but preserved for functionality -->
    <div style="display:none">
      <input id="baseUrl" type="text" value="http://127.0.0.1:8000">
      <div id="healthResult"></div>
    </div>
  </aside>
</main>

<!-- Floating robot -->
<button class="robot-btn" id="openChat" title="Open chat">ü§ñ</button>

<!-- Chat overlay -->
<div class="overlay" id="chatOverlay">
  <div class="chat-modal auth-modal">
    <div class="chat-header">
      <strong>FarmSathi Robot</strong>
      <div>
        <button class="btn ghost" onclick="closeChat()">Close</button>
      </div>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="bubble">Hello! I'm FarmSathi. Ask me about crops, fertilizers, pests...</div>
    </div>
    <div style="padding:8px">
      <div class="chat-input">
        <input id="chatField" placeholder="Type your question...">
        <button class="btn" onclick="sendChatFromModal()">Send</button>
      </div>
    </div>
  </div>
</div>

  <footer>FarmSathi UI ‚Ä¢ AI can sometimes make mistakes. Please verify important information.</footer>

<script>
/* ========= CONFIG ========= */
let BASE_URL = localStorage.getItem('FS_BASE_URL') || document.getElementById('baseUrl').value;
document.getElementById('baseUrl').value = BASE_URL;

/* ========= HELPERS ========= */
function showResultBox(id, lines){
  // `lines` can be string or array of lines
  const el = document.getElementById(id);
  if(!el) return;
  if(Array.isArray(lines)) el.innerHTML = lines.map(l => `<div>${l}</div>`).join('');
  else el.textContent = lines;
}

function showErrorBox(id, err){
  const message = (err && err.detail) ? err.detail : (err && err.message) ? err.message : JSON.stringify(err);
  showResultBox(id, `‚ùå Error: ${message}`);
}

/* ========= PREVIEW FILE ========= */
function showPreview(file){
  const area = document.getElementById('previewArea');
  area.innerHTML = '';
  if(!file) return;
  const img = document.createElement('img');
  img.src = URL.createObjectURL(file);
  img.onload = ()=> URL.revokeObjectURL(img.src);
  img.style.maxWidth = '160px';
  img.style.borderRadius = '8px';
  area.appendChild(img);
}
// Attach preview listener only if the element exists on this page
const dfileEl = document.getElementById('dfile');
if (dfileEl) {
  dfileEl.addEventListener('change', (e) => showPreview(e.target.files[0]));
}

/* ========= API CALLS ========= */

/* -- Crop Recommendation -- */
async function callCropRecommend(){
  const form = new FormData();
  form.append('nitrogen', document.getElementById('crop_n').value);
  form.append('phosphorus', document.getElementById('crop_p').value);
  form.append('potassium', document.getElementById('crop_k').value);
  form.append('temperature', document.getElementById('crop_temp').value);
  form.append('humidity', document.getElementById('crop_hum').value);
  form.append('ph', document.getElementById('crop_ph').value);
  form.append('rainfall', document.getElementById('crop_rain').value);

  showResultBox('cropResult', '‚è≥ Sending request...');
  try{
    const res = await fetch(`${BASE_URL}/crop-recommend`, { method:'POST', body:form });
    const json = await res.json();
    if(!res.ok) return showErrorBox('cropResult', json);
    showResultBox('cropResult', [
      `üå± Recommended Crop: ${json.recommended_crop ?? 'N/A'}`
    ]);
  }catch(err){
    showErrorBox('cropResult', err);
  }
}

/* -- Fertilizer Recommendation -- */
async function callFertilizer(){
  const form = new FormData();
  form.append('temp', document.getElementById('fert_temp').value);
  form.append('humidity', document.getElementById('fert_hum').value);
  form.append('moisture', document.getElementById('fert_moist').value);
  form.append('nitrogen', document.getElementById('fert_n').value);
  form.append('phosphorous', document.getElementById('fert_p').value);
  form.append('potassium', document.getElementById('fert_k').value);
  form.append('ph', document.getElementById('fert_ph').value);
  form.append('soil_type', document.getElementById('fert_soil').value);
  form.append('crop_type', document.getElementById('fert_crop').value);

  document.getElementById('fertStatus').textContent = 'sending...';
  showResultBox('fertResult', '‚è≥ Sending request...');
  try{
    const res = await fetch(`${BASE_URL}/fertilizer-recommend`, { method:'POST', body:form });
    const json = await res.json();
    if(!res.ok){
      document.getElementById('fertStatus').textContent = 'error';
      return showErrorBox('fertResult', json);
    }
    document.getElementById('fertStatus').textContent = 'success';
    showResultBox('fertResult', [`üíß Recommended Fertilizer: ${json.recommended_fertilizer ?? 'N/A'}`]);
  }catch(err){
    document.getElementById('fertStatus').textContent = 'error';
    showErrorBox('fertResult', err);
  }
}

/* -- Crop Stats -- */
async function callCropStats(){
  const name = document.getElementById('stats_crop').value.trim();
  if(!name) return showResultBox('statsResult', '‚ö†Ô∏è Please provide a crop name.');
  showResultBox('statsResult', '‚è≥ Fetching statistics...');
  try{
    const res = await fetch(`${BASE_URL}/crop-stats/${encodeURIComponent(name)}`);
    const json = await res.json();
    if(!res.ok) return showErrorBox('statsResult', json);
    // Nicely format statistics + summary
    const stats = json.statistics || {};
    const summary = json.summary || 'No summary available.';
    const params = stats.Parameter || [];
    const min = stats.Minimum || [];
    const avg = stats.Average || [];
    const max = stats.Maximum || [];
    const lines = ['üìà Statistics:'];
    for(let i=0;i<params.length;i++){
      lines.push(`${params[i]} ‚Äî min: ${formatNumber(min[i])} | avg: ${formatNumber(avg[i])} | max: ${formatNumber(max[i])}`);
    }
    lines.push('');
    lines.push('üìù Summary:');
    lines.push(summary);
    showResultBox('statsResult', lines);
  }catch(err){
    showErrorBox('statsResult', err);
  }
}
function formatNumber(v){ return (v === undefined || v === null || isNaN(v)) ? 'N/A' : Number(v).toFixed(2); }

/* -- Disease Detection -- */
function validateAndCompressImage(file) {
  return new Promise((resolve, reject) => {
    if (!file.type.startsWith('image/')) {
      reject(new Error('Please select an image file'));
      return;
    }
    
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 224;  // Match backend expected size
        canvas.height = 224;
        ctx.drawImage(img, 0, 0, 224, 224);
        canvas.toBlob((blob) => {
          resolve(new File([blob], file.name, { type: 'image/jpeg' }));
        }, 'image/jpeg', 0.8);
      };
      img.onerror = () => reject(new Error('Failed to load image'));
    };
    reader.onerror = () => reject(new Error('Failed to read file'));
  });
}

async function callDisease(){
  const fileInput = document.getElementById('dfile');
  if(!fileInput.files.length) return showResultBox('diseaseResult', '‚ö†Ô∏è Select an image first.');
  
  document.getElementById('dloader').style.display='inline-block';
  document.getElementById('dstatus').textContent = 'processing...';
  showResultBox('diseaseResult', '‚è≥ Processing image...');

  try {
    const compressedFile = await validateAndCompressImage(fileInput.files[0]);
    const form = new FormData();
    form.append('file', compressedFile);

    document.getElementById('dstatus').textContent = 'uploading...';
    showResultBox('diseaseResult', '‚è≥ Uploading & analyzing image...');

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
    
    const res = await fetch(`${BASE_URL}/predict-disease`, { 
      method:'POST', 
      body: form,
      signal: controller.signal 
    });
    clearTimeout(timeoutId);
    const json = await res.json();
    if(!res.ok) return showErrorBox('diseaseResult', json);

    // backend returns keys: predicted_disease, confidence, recommendation
    const disease = json.predicted_disease ?? json.disease ?? 'Unknown';
    const conf = json.confidence ?? json.confidence_percent ?? 'N/A';
    const rec = json.recommendation ?? json.treatment ?? 'No recommendation provided.';

    // Format recommendation text to ensure each point is on a new line
    const formattedRec = rec.split('\n').filter(line => line.trim()).map(line => {
      line = line.trim();
      // Keep existing numbered points (1., 2., etc.)
      if (/^\d+\./.test(line)) return line;
      // Keep existing bullet points
      if (line.startsWith('‚Ä¢')) return line;
      // Add bullet for unnumbered lines
      return `‚Ä¢ ${line}`;
    });
    
    showResultBox('diseaseResult', [
      `üåø Disease: ${disease}`,
      `‚úÖ Confidence: ${conf}${typeof conf === 'number' ? '%' : ''}`,
      '',
      'üõ† Recommendation:',
      ...formattedRec  // Spread the formatted points
    ]);
    document.getElementById('dstatus').textContent = 'success';
  } catch(err) {
    if (err.name === 'AbortError') {
      showResultBox('diseaseResult', '‚ö†Ô∏è Request timed out. Please try again.');
    } else if (err.message && err.message.includes('image')) {
      showResultBox('diseaseResult', `‚ö†Ô∏è ${err.message}`);
    } else {
      showErrorBox('diseaseResult', err);
    }
    document.getElementById('dstatus').textContent = 'error';
  } finally {
    document.getElementById('dloader').style.display='none';
  }
}

/* -- Chatbot Inline -- */
async function callChatbotInline(){
  const q = document.getElementById('chatInput').value.trim();
  if(!q) return showResultBox('chatResult', '‚ö†Ô∏è Enter a question first.');
  showResultBox('chatResult', '‚è≥ Sending to chatbot...');
  const form = new FormData();
  form.append('query', q);
  try{
    const res = await fetch(`${BASE_URL}/chatbot`, { method:'POST', body:form });
    const json = await res.json();
    if(!res.ok) return showErrorBox('chatResult', json);
    showResultBox('chatResult', [`ü§ñ FarmSathi:`, json.response ?? 'No response.']);
  }catch(err){
    showErrorBox('chatResult', err);
  }
}

/* --- Chat modal handlers (small) --- */
document.getElementById('openChat').addEventListener('click', ()=> {
  document.getElementById('chatOverlay').style.display='flex';
  scrollChatToBottom();
});
function closeChat(){ document.getElementById('chatOverlay').style.display='none'; }
async function sendChatFromModal(){
  const q = document.getElementById('chatField').value.trim();
  if(!q) return;
  appendChatBubble(q, 'user');
  document.getElementById('chatField').value='';
  appendChatBubble('‚Ä¶thinking', 'bot');
  try{
    const form = new FormData();
    form.append('query', q);
    const res = await fetch(`${BASE_URL}/chatbot`, { method:'POST', body: form });
    const json = await res.json();
    removeThinking();
    if(!res.ok) {
      appendChatBubble('Error: ' + (json.detail || JSON.stringify(json)), 'bot');
      return;
    }
    appendChatBubble(json.response || JSON.stringify(json), 'bot');
  }catch(err){
    removeThinking();
    appendChatBubble('Error: ' + (err.message || JSON.stringify(err)), 'bot');
  }
}
function appendChatBubble(text, cls){
  const el = document.createElement('div');
  el.className = 'bubble ' + (cls === 'user' ? 'user' : '');
  el.textContent = text;
  document.getElementById('chatBody').appendChild(el);
  scrollChatToBottom();
}
function removeThinking(){
  const body = document.getElementById('chatBody');
  const nodes = Array.from(body.children);
  const thinking = nodes.find(n => n.textContent === '‚Ä¶thinking');
  if(thinking) thinking.remove();
}
function scrollChatToBottom(){ const el=document.getElementById('chatBody'); setTimeout(()=> el.scrollTop = el.scrollHeight, 80); }
function clearChat(){ document.getElementById('chatResult').textContent = ''; }

/* --- Health check --- */
async function testHealth(){
  showResultBox('healthResult','‚è≥ Checking server health...');
  try{
    const res = await fetch(`${BASE_URL}/`);
    const json = await res.json();
    if(!res.ok) return showErrorBox('healthResult', json);
    showResultBox('healthResult', [`‚úÖ Server reachable`, `Response: ${JSON.stringify(json)}`]);
  }catch(err){
    showErrorBox('healthResult', err);
  }
}

/* --- Crop list helper (optional) --- */
async function loadCropList(){
  showResultBox('statsResult','‚è≥ Checking crop-stats root...');
  try{
    const res = await fetch(`${BASE_URL}/crop-stats`);
    if(res.ok){
      showResultBox('statsResult','Crop-stats root exists (try /crop-stats/{name})');
    } else {
      showResultBox('statsResult','No generic crop-stats root. Call /crop-stats/{name} instead.');
    }
  }catch(e){
    showErrorBox('statsResult', e);
  }
}

/* ============ UTILITIES ============ */
function saveBaseUrl(){
  BASE_URL = document.getElementById('baseUrl').value.trim();
  localStorage.setItem('FS_BASE_URL', BASE_URL);
  alert('Saved base URL: ' + BASE_URL);
}

/* ============ INIT ============ */
(function init(){
  localStorage.setItem('FS_BASE_URL', BASE_URL);
  // hide loader initially
  document.getElementById('dloader').style.display='none';
})();
</script>
</body>
</html>
